#include "display.h"
#include <string.h>
#include "defines.h"

static const uint8_t boot_logo[] = {
	// boot_logo, 128x64px
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xf8, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xf8, 0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xcf, 0xff, 0xff, 0xfe, 0x7f, 0xf8, 0x7c, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xe7, 0xff, 0xff, 0xfc, 0xff, 0xf8, 0x7c, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xf3, 0xff, 0xff, 0xf9, 0xff, 0xf8, 0x7c, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 
	0xff, 0xfb, 0xff, 0xff, 0xf3, 0xff, 0xf8, 0x7c, 0x1f, 0x00, 0x3f, 0x00, 0x7f, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xfc, 0x0f, 0xff, 0xff, 0xf8, 0x7f, 0xfe, 0x00, 0xff, 0xc3, 0xff, 0xc0, 0xf8, 0x00, 
	0xff, 0xff, 0xf1, 0xf1, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0x01, 0xff, 0xe1, 0xff, 0xe0, 0xf8, 0x00, 
	0xff, 0xff, 0xc7, 0xfc, 0xff, 0xff, 0xf8, 0x7f, 0xff, 0x83, 0xff, 0xe1, 0xff, 0xf0, 0xf8, 0x00, 
	0xff, 0xff, 0x9f, 0xff, 0x7f, 0xff, 0xf8, 0x7f, 0xff, 0xc3, 0xe3, 0xf1, 0xc3, 0xf0, 0xf8, 0x00, 
	0xff, 0xff, 0x3c, 0x7f, 0xbf, 0xff, 0xf8, 0x7f, 0xff, 0xc7, 0xe1, 0xf0, 0x01, 0xf0, 0xf8, 0x00, 
	0xff, 0xff, 0x71, 0xff, 0x9f, 0xff, 0xf8, 0x7c, 0x0f, 0xe7, 0xff, 0xf0, 0x3f, 0xf0, 0xf8, 0x00, 
	0xff, 0xfe, 0x67, 0xff, 0xcf, 0xff, 0xf8, 0x7c, 0x07, 0xe7, 0xff, 0xf0, 0xff, 0xf0, 0xf8, 0x00, 
	0xff, 0xfe, 0xef, 0xff, 0xcf, 0xff, 0xf8, 0x7c, 0x07, 0xe7, 0xff, 0xf1, 0xff, 0xf0, 0xf8, 0x00, 
	0xff, 0xfe, 0xcf, 0xff, 0xef, 0xff, 0xf8, 0x7c, 0x07, 0xe7, 0xe0, 0x03, 0xf1, 0xf0, 0xf8, 0x00, 
	0xff, 0xfd, 0xdf, 0xff, 0xef, 0xff, 0xf8, 0x7c, 0x0f, 0xc3, 0xf0, 0x03, 0xf1, 0xf0, 0xf8, 0x00, 
	0xff, 0xfd, 0xdf, 0xff, 0xef, 0xff, 0xf8, 0x7f, 0xff, 0xc3, 0xff, 0xe3, 0xff, 0xf0, 0xfe, 0x00, 
	0xf0, 0x3d, 0xdf, 0xff, 0xe7, 0x81, 0xf8, 0x7f, 0xff, 0x81, 0xff, 0xe3, 0xff, 0xf0, 0xff, 0x00, 
	0xff, 0xfd, 0xff, 0xff, 0xef, 0xff, 0xf8, 0x7f, 0xff, 0x00, 0xff, 0xe1, 0xff, 0xf0, 0x7f, 0x00, 
	0xff, 0xfc, 0xff, 0xff, 0xef, 0xff, 0xf8, 0x7f, 0xf8, 0x00, 0x3f, 0xc0, 0x7c, 0xf0, 0x3f, 0x00, 
	0xff, 0xfe, 0xff, 0xff, 0xef, 0xff, 0xf8, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xfe, 0xff, 0xff, 0xcf, 0xff, 0xf8, 0x00, 0x00, 0xf0, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0x7f, 0xff, 0xdf, 0xff, 0xf8, 0x7c, 0x01, 0xf8, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0x7f, 0xff, 0x9f, 0xff, 0xf8, 0x7c, 0x01, 0xf8, 0x00, 0x00, 0xf0, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xbf, 0xff, 0xbf, 0xff, 0xf8, 0x7c, 0x00, 0xf0, 0x00, 0x00, 0xf0, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0x9f, 0xff, 0x3f, 0xff, 0xf8, 0x7c, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xdf, 0xfe, 0x7f, 0xff, 0xf8, 0x7c, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0xf8, 0x00, 
	0xff, 0xff, 0xcf, 0xfe, 0xff, 0xff, 0xf8, 0x7c, 0x00, 0xf0, 0x3e, 0x70, 0xf7, 0xc3, 0xff, 0x00, 
	0xff, 0xf9, 0xef, 0xfc, 0xf3, 0xff, 0xf8, 0x7c, 0x00, 0xf0, 0x7f, 0xf0, 0xff, 0xe3, 0xff, 0x00, 
	0xff, 0xf3, 0xe7, 0xfd, 0xf9, 0xff, 0xf8, 0x7c, 0x00, 0xf0, 0xff, 0xf0, 0xff, 0xf3, 0xff, 0x00, 
	0xff, 0xe7, 0xf7, 0xfd, 0xfd, 0xff, 0xf8, 0x7c, 0x00, 0xf0, 0xff, 0xf0, 0xff, 0xf3, 0xff, 0x00, 
	0xff, 0xcf, 0xf7, 0xf9, 0xfe, 0xff, 0xf8, 0x7c, 0x00, 0xf1, 0xf1, 0xf0, 0xf9, 0xf8, 0xf8, 0x00, 
	0xff, 0xff, 0xf0, 0x01, 0xff, 0xff, 0xf8, 0x7c, 0x00, 0xf1, 0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7c, 0x00, 0xf1, 0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7c, 0x00, 0xf1, 0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0x00, 
	0xff, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xf8, 0x7c, 0x00, 0xf1, 0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0x00, 
	0xff, 0xff, 0xf8, 0x07, 0xff, 0xff, 0xf8, 0x7c, 0x00, 0xf1, 0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0x00, 
	0xff, 0xff, 0xfb, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0xf8, 0xf1, 0xff, 0xf0, 0xf0, 0xf8, 0xff, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0xf8, 0xf0, 0xff, 0xf0, 0xf0, 0xf8, 0x7f, 0x00, 
	0xff, 0xff, 0xff, 0x03, 0xff, 0xff, 0xf8, 0x7f, 0xf8, 0xf0, 0x7f, 0xf0, 0xf0, 0xf8, 0x7f, 0x00, 
	0xff, 0xff, 0xf0, 0x3f, 0xff, 0xff, 0xf8, 0x7f, 0xf8, 0xf0, 0x3e, 0xf0, 0xf0, 0xf8, 0x1f, 0x80, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xf0, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xe0, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void dislay_welcome(ssd1306_handle_t dev, int force_refresh) {

    char str[50];

    if (!force_refresh)
        return ;

    ssd1306_clear_screen(dev, false);
    ssd1306_draw_bitmap(dev, 0, 0, boot_logo, 128, 64);
    //ssd1306_draw_string(dev, 0, 0, (unsigned char *)str, 12, true);
    ssd1306_refresh_gram(dev);
}

void dislay_light_select(ssd1306_handle_t dev, int *light_selected, struct lights_t *lights, int force_refresh) {

    char str[50];

    static int save_light_selected;
    static int save_rssi;

    if (save_light_selected == *light_selected && force_refresh == 0 && save_rssi == lights->rssi[*light_selected])
        return ;

    save_light_selected = *light_selected;
    save_rssi = lights->rssi[*light_selected];


    ssd1306_clear_screen(dev, false);

    sprintf(str, "Light Selection");
    ssd1306_draw_string(dev, 17, 0, (unsigned char *)str, 12, true);

    ssd1306_draw_line(dev, 0, 13, 128, 12);

    sprintf(str, "Current selected : %d", *light_selected);
    ssd1306_draw_string(dev, 0, 20, (unsigned char *)str, 12, true);

    if (lights->clients_last_seen[*light_selected] < 1000) {
        sprintf(str, "RSSI : %d", lights->rssi[*light_selected]);
    }
    else {
        sprintf(str, "Offline");
    }
    ssd1306_draw_string(dev, 0, 32, (unsigned char *)str, 12, true);

    ssd1306_refresh_gram(dev);
}

#define DIV_ADAPT 3

void dislay_rgb_ctrl(ssd1306_handle_t dev, int light_selected, struct lights_t *lights) {
    
    char str[50];

    int padding = 0;
    int bar_size;

    ssd1306_clear_screen(dev, false);

    sprintf(str, "Light : %d", light_selected);
    ssd1306_draw_string(dev, 0, 0, (unsigned char *)str, 12, true);

    ssd1306_draw_line(dev, 0, 13, 128, 12);

    padding = 10;
    bar_size = lights->light[light_selected].r / DIV_ADAPT;

    //printf("bar size r -- %d: %d\n", light_selected, lights->light[light_selected].r);

    ssd1306_fill_rectangle(dev, padding, 51-bar_size, padding+4, 51, 1);
    sprintf(str, "r");
    ssd1306_draw_string(dev, padding, 52, (unsigned char *)str, 12, true);

    padding += 24;
    bar_size = lights->light[light_selected].g / DIV_ADAPT;
    ssd1306_fill_rectangle(dev, padding, 51-bar_size, padding+4, 51, 1);
    sprintf(str, "g");
    ssd1306_draw_string(dev, padding, 52, (unsigned char *)str, 12, true);

    padding += 24;
    bar_size = lights->light[light_selected].b / DIV_ADAPT;
    ssd1306_fill_rectangle(dev, padding, 51-bar_size, padding+4, 51, 1);
    sprintf(str, "b");
    ssd1306_draw_string(dev, padding, 52, (unsigned char *)str, 12, true);

    padding += 24;
    bar_size = lights->light[light_selected].w / DIV_ADAPT;
    ssd1306_fill_rectangle(dev, padding, 51-bar_size, padding+4, 51, 1);
    sprintf(str, "w");
    ssd1306_draw_string(dev, padding, 52, (unsigned char *)str, 12, true);

    padding += 24;
    bar_size = lights->light[light_selected].y / DIV_ADAPT;
    ssd1306_fill_rectangle(dev, padding, 51-bar_size, padding+4, 51, 1);
    sprintf(str, "y");
    ssd1306_draw_string(dev, padding, 52, (unsigned char *)str, 12, true);

    ssd1306_refresh_gram(dev);
}

void dislay_devices(ssd1306_handle_t dev, struct lights_t *lights) {

    char str[50];

    int is_here;
    int i;
    int x, y;

    ssd1306_clear_screen(dev, false);

    x = 0;
    y = 0;
    for (i=1;i<20;i++) {

        if (lights->clients_last_seen[i] < 1000)
            is_here = 1;
        else
            is_here = 0;

        sprintf(str, "%d", i);
        ssd1306_draw_string(dev, x, y, (unsigned char *)str, 12, !is_here);

        y += 13;
        if (y > (13*4)) {
            y = 0;
            x += 34;
        }
    }

    ssd1306_refresh_gram(dev);
    
}